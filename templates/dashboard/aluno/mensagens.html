{% extends "dashboard/base_dashboard.html" %}
{% load django_tables2 %}
{% load static %}

{% block titulo %}Mensagens{% endblock %}

{% block conteudo %}
<h2 class="title-dashboard mb-4 d-flex align-items-center justify-content-between">

    <span>
        <i class="bi bi-envelope me-2"></i>
        Minhas Mensagens
    </span>

    <button type="button" 
            class="btn-msg d-flex align-items-center gap-2"
            onclick="abrirModalEnviarMensagem()">
        <i class="bi bi-send"></i>
        Enviar nova mensagem
    </button>

</h2>

<!-- ===== TABS PARA NAVEGAÇÃO ===== -->
<div class="mb-4">
    <ul class="nav nav-tabs" id="mensagensTab" role="tablist">
        <!-- ABA ENVIADAS AGORA VEM PRIMEIRO -->
        <li class="nav-item" role="presentation">
            <button class="nav-link active" 
                    id="enviadas-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#enviadas" 
                    type="button" 
                    role="tab">
                <i class="bi bi-envelope-paper me-1"></i>
                Enviadas
                <span class="badge bg-secondary ms-2">{{ table_enviadas.page.object_list|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" 
                    id="respondidas-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#respondidas" 
                    type="button" 
                    role="tab">
                <i class="bi bi-envelope-check me-1"></i>
                Respondidas
                <span class="badge bg-secondary ms-2">{{ table_respondidas.page.object_list|length }}</span>
            </button>
        </li>
    </ul>
</div>

<div class="tab-content" id="mensagensTabContent">
    <!-- ===== ABA: MENSAGENS ENVIADAS ===== -->
    <div class="tab-pane fade show active" 
         id="enviadas" 
         role="tabpanel" 
         aria-labelledby="enviadas-tab">
        
        {% if table_enviadas.page.object_list %}
        <div class="table-container">
            {% render_table table_enviadas %}
        </div>

        <!-- Modais para mensagens enviadas -->
        {% for row in table_enviadas.page.object_list %}
        {% with msg=row.record %}
        <div id="mensagem-enviada-{{ msg.id }}" class="modal-vaga">
            <div class="modal-content-vaga">
                <a href="#" class="modal-close"><i class="bi bi-x-lg"></i></a>
                <h3 class="fw-bold mb-3">
                    <i class="bi bi-chat-text me-2"></i>
                    Mensagem Enviada
                </h3>

                <!-- Adiciona o assunto se existir -->
                {% if msg.assunto %}
                <div class="mb-3">
                    <p class="mb-1"><strong>Assunto:</strong></p>
                    <p class="text-muted">{{ msg.assunto }}</p>
                </div>
                {% endif %}

                <p><strong>Sua mensagem:</strong></p>
                <div class="message-bubble sent">
                    <p>{{ msg.mensagem }}</p>
                    <small class="text-muted">{{ msg.data_envio|date:"d/m/Y H:i" }}</small>
                </div>

                <!-- Se já foi respondida, mostra a resposta -->
                {% if msg.respondido and msg.resposta %}
                <p class="mt-4 mb-2"><strong>Resposta da coordenação:</strong></p>
                <div class="message-bubble received">
                    <p>{{ msg.resposta }}</p>
                    <small class="text-muted">
                        Respondido em: 
                        {% if msg.data_resposta %}
                            {{ msg.data_resposta|date:"d/m/Y H:i" }}
                        {% else %}
                            Data não registrada
                        {% endif %}
                    </small>
                </div>
                {% else %}
                <div class="mt-4">
                    <p class="text-warning mb-2">
                        <i class="bi bi-clock-history me-1"></i>
                        Aguardando resposta da coordenação
                    </p>
                </div>
                {% endif %}

                <div class="d-flex justify-content-end mt-4">
                    <a href="#" class="btn-table" style="background: var(--gray-300); color: var(--gray-800);">
                        Fechar
                    </a>
                </div>
            </div>
        </div>
        {% endwith %}
        {% endfor %}

        {% else %}
        <div class="empty-state-wrapper d-flex align-items-center justify-content-center gap-4 py-5">
            <img src="{% static 'assets/img/empty.svg' %}" 
                 class="empty-img" 
                 style="width: 320px; max-width: 100%;">
            <div class="empty-state-text" style="max-width: 380px;">
                <h5 class="fw-bold mb-2">Nenhuma mensagem enviada</h5>
                <p class="text-muted m-0">
                    Envie sua primeira mensagem para a coordenação usando o botão acima.
                </p>
            </div>
        </div>
        {% endif %}

    </div>

    <!-- ===== ABA: MENSAGENS RESPONDIDAS (AGORA É A SEGUNDA) ===== -->
    <div class="tab-pane fade" 
         id="respondidas" 
         role="tabpanel" 
         aria-labelledby="respondidas-tab">
        
        {% if table_respondidas.page.object_list %}
        <div class="table-container">
            {% render_table table_respondidas %}
        </div>

        <!-- Modais para mensagens respondidas -->
        {% for row in table_respondidas.page.object_list %}
        {% with msg=row.record %}
        <div id="mensagem-respondida-{{ msg.id }}" class="modal-vaga">
            <div class="modal-content-vaga">
                <a href="#" class="modal-close"><i class="bi bi-x-lg"></i></a>
                <h3 class="fw-bold mb-3">
                    <i class="bi bi-chat-text me-2"></i>
                    Detalhes da Mensagem
                </h3>

                <!-- Adiciona o assunto se existir -->
                {% if msg.assunto %}
                <div class="mb-3">
                    <p class="mb-1"><strong>Assunto:</strong></p>
                    <p class="text-muted">{{ msg.assunto }}</p>
                </div>
                {% endif %}

                <p><strong>Sua mensagem:</strong></p>
                <div class="message-bubble sent mb-3">
                    <p>{{ msg.mensagem }}</p>
                    <small class="text-muted">{{ msg.data_envio|date:"d/m/Y H:i" }}</small>
                </div>

                <p><strong>Resposta da coordenação:</strong></p>
                <div class="message-bubble received">
                    <p>{{ msg.resposta }}</p>
                    <small class="text-muted">
                        Respondido em: 
                        {% if msg.data_resposta %}
                            {{ msg.data_resposta|date:"d/m/Y H:i" }}
                        {% else %}
                            Data não registrada
                        {% endif %}
                    </small>
                </div>

                <div class="d-flex justify-content-end mt-4">
                    <a href="#" class="btn-table" style="background: var(--gray-300); color: var(--gray-800);">
                        Fechar
                    </a>
                </div>
            </div>
        </div>
        {% endwith %}
        {% endfor %}

        {% else %}
        <div class="empty-state-wrapper d-flex align-items-center justify-content-center gap-4 py-5">
            <img src="{% static 'assets/img/empty.svg' %}" 
                 class="empty-img" 
                 style="width: 320px; max-width: 100%;">
            <div class="empty-state-text" style="max-width: 380px;">
                <h5 class="fw-bold mb-2">Nenhuma resposta recebida</h5>
                <p class="text-muted m-0">
                    Assim que a coordenação responder alguma mensagem sua, ela aparecerá aqui.
                </p>
            </div>
        </div>
        {% endif %}

    </div>
</div>

<!-- ===== MODAL PARA ENVIAR NOVA MENSAGEM ===== -->
<div id="modalEnviarMensagem" class="modal-vaga">
    <div class="modal-content-vaga" style="max-width: 600px;">
        <a href="#" class="modal-close" onclick="fecharModalEnviarMensagem()">
            <i class="bi bi-x-lg"></i>
        </a>

        <h3 class="fw-bold mb-4">
            <i class="bi bi-send me-2"></i>
            Enviar Nova Mensagem
        </h3>

        <form id="formEnviarMensagem" method="POST" action="{% url 'dashboard:aluno_enviar_mensagem' %}">
            {% csrf_token %}
            
            <div class="mb-4">
                <label for="assunto" class="form-label fw-bold">
                    Assunto <span class="text-danger">*</span>
                </label>
                <input type="text" 
                       class="form-control" 
                       id="assunto" 
                       name="assunto" 
                       placeholder="Digite o assunto da mensagem" 
                       required>
                <div class="form-text">
                    Ex: Dúvida sobre horários, Solicitação de documento, etc.
                </div>
            </div>

            <div class="mb-4">
                <label for="mensagem" class="form-label fw-bold">
                    Mensagem <span class="text-danger">*</span>
                </label>
                <textarea class="form-control" 
                          id="mensagem" 
                          name="mensagem" 
                          rows="6" 
                          placeholder="Digite sua mensagem aqui..." 
                          required></textarea>
                <div class="form-text">
                    Sua mensagem será enviada para a coordenação. Você receberá uma resposta por aqui.
                </div>
            </div>

            <div class="d-flex justify-content-end gap-3 mt-4">
                <button type="button" 
                        class="btn-table" 
                        style="background: var(--gray-300); color: var(--gray-800);"
                        onclick="fecharModalEnviarMensagem()">
                    Cancelar
                </button>
                <button type="submit" class="btn-msg">
                    <i class="bi bi-send me-2"></i>
                    Enviar Mensagem
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    .message-bubble {
        padding: 12px 16px;
        border-radius: 12px;
        margin-bottom: 8px;
        max-width: 80%;
    }
    
    .message-bubble.sent {
        background-color: #e3f2fd;
        border: 1px solid #bbdefb;
        margin-left: auto;
    }
    
    .message-bubble.received {
        background-color: #f5f5f5;
        border: 1px solid #e0e0e0;
        margin-right: auto;
    }
    
    .nav-tabs .nav-link {
        color: var(--gray-600);
        font-weight: 500;
        border: none;
        padding: 12px 24px;
    }
    
    .nav-tabs .nav-link.active {
        color: var(--primary);
        border-bottom: 3px solid var(--primary);
        background-color: transparent;
    }
    
    .nav-tabs .nav-link:hover {
        color: var(--primary-dark);
    }
    
    .no-data {
        color: #6c757d;
        font-style: italic;
    }
</style>

<script>
    function abrirModalEnviarMensagem() {
        document.getElementById('modalEnviarMensagem').style.display = 'flex';
    }
    
    function fecharModalEnviarMensagem() {
        document.getElementById('modalEnviarMensagem').style.display = 'none';
    }
    
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('modalEnviarMensagem');
        if (event.target === modal) {
            fecharModalEnviarMensagem();
        }
    });
    
    document.getElementById('formEnviarMensagem').addEventListener('submit', function(e) {
        e.preventDefault();

        
        this.submit();
    });
    
    document.querySelector('#modalEnviarMensagem .modal-close').addEventListener('click', function() {
        document.getElementById('mensagem').focus();
    });
</script>

{% endblock %}
